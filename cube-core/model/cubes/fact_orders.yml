cubes:
  - name: FactOrders
    sql_table: ticketshopdb.`FACT_Orders`
    data_source: default
    title: Orders Table
    description: Table contaning one row per order_id and ticket_id combination, along with quantity and order value and other dimensional attributes which are needed to link an order to dimensions metadata.
    
    joins:
      - name: DimEvents
        sql: "{CUBE}.event_id = {DimEvents}.guid"
        relationship: many_to_one
        
      - name: DimTickets
        sql: "{CUBE}.ticket_id = {DimTickets}.guid"
        relationship: many_to_one
        
      - name: DimShops
        sql: "{CUBE}.shop_id = {DimShops}.guid"
        relationship: many_to_one
    
    dimensions:

      - name: order_line_id
        sql: "CONCAT({CUBE}.order_id, '-', {CUBE}.ticket_id)"
        type: string
        primary_key: true
        description: Composite primary key for (order_id, ticket_id).

      - name: order_id
        sql: order_id
        type: string
        title: Order ID
        description: Unique identifier for each order.
        
      - name: email
        sql: email
        type: string
        title: Visitor (or attendee) Email
        description: Email address of the visitor (or attendee) who placed the order.
        
      - name: ticket_id
        sql: ticket_id
        type: string
        title: Ticket ID
        description: Unique identifier for each ticket associated with the order.
        
      - name: company_id
        sql: company_id
        type: string
        title: Company ID
        description: Identifier for the company associated with the order.
        
      - name: shop_id
        sql: shop_id
        type: string
        title: Shop ID
        description: Identifier for the company shop where the order was placed.
        
      - name: event_id
        sql: event_id
        type: string
        title: Event ID
        description: Identifier for the event associated with the order.
        
      - name: payment_method
        sql: payment_method
        type: string
        title: Payment Method
        description: Payment method used for the order (e.g., credit card, PayPal).
        
      - name: currency
        sql: currency
        type: string
        title: Currency
        description: Currency in which the order was placed (e.g., USD, EUR).
        
      - name: refund_protect
        sql: refund_protect
        type: boolean
        title: Refund Protection
        description: Indicates whether refund protection was purchased for the order.
        
      - name: order_date_raw
        sql: order_date
        type: string

      - name: order_date
        sql: "STR_TO_DATE({CUBE}.order_date, '%m/%d/%Y')"
        type: time
        title: Order Date
        description: Date when the order was placed.
            
    measures:
      - name: orders_count
        type: count_distinct
        sql: order_id
        description: Unique orders (distinct order_id).
        drill_members: [order_id, email, order_date]

      - name: revenues
        sql: order_value
        type: sum
        description: Gross merchandise value (sum of order_value in source currency).

      - name: tickets_sold
        sql: ticket_count
        type: sum
        description: Total tickets sold (sum of ticket_count).

      - name: avg_order_value
        type: number
        sql: "{revenues} / NULLIF({orders_count}, 0)"
        description: Revenues divided by unique orders.

      - name: avg_tickets_per_order
        type: number
        sql: "{tickets_sold} / NULLIF({orders_count}, 0)"
        description: Tickets per unique order.

      - name: card_orders
        type: sum
        sql: "CASE WHEN {CUBE}.payment_method = 'Credit Card' THEN 1 ELSE 0 END"
        description: Count of orders paid by Credit Card.